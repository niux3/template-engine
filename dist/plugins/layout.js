const k=(w,f)=>{const b=new Map;w.layout=(r,o)=>(b.set(r,o),w);const g=r=>{const o={},i=/\[\[block:(\w+)\]\]/g;let c;for(;c=i.exec(r);){const u=c[1],l=i.lastIndex;let a=1,e=l,n=-1;for(;a>0&&e<r.length;){const t=r.indexOf("[[block:",e),s=r.indexOf("[[/block]]",e);if(s===-1)break;if(t!==-1&&t<s)a++,e=t+8;else{if(a--,a===0){n=s;break}e=s+10}}n!==-1&&(o[u]=r.substring(l,n).trim())}return o},h=r=>{const o=r.match(/\[\[extends:(\w+)\]\]/);return o?o[1]:null},d=(r,o={},i=0)=>{if(i>10)throw new Error("Layout inheritance too deep (max 10 levels)");const c=h(r),u=g(r);if(!c){let e=r;return e=e.replace(/\[\[block:(\w+)\]\]([\s\S]*?)\[\[\/block\]\]/g,(n,t,s)=>{const p=o[t]||u[t];return p!==void 0?p.includes("[[parent]]")?p.replace(/\[\[parent\]\]/g,s.trim()):p:s}),e=e.replace(/\[\[block:(\w+)\]\]([\s\S]*?)\[\[\/block\]\]/g,(n,t,s)=>o[t]!==void 0?o[t]:s.trim()||""),e=e.replace(/\[\[extends:\w+\]\]/,""),e}if(!b.has(c))throw new Error(`Layout "${c}" not found`);const l={};for(const[e,n]of Object.entries(o))if(n.includes("[[parent]]")){const t=u[e]||"";l[e]=n.replace(/\[\[parent\]\]/g,t.trim())}else l[e]=n;const a={...u,...l};return d(b.get(c),a,i+1)};f.preprocessors||(f.preprocessors=[]),f.preprocessors.unshift(r=>{try{return d(r,{},0)}catch(o){throw new Error(`Layout resolution failed: ${o.message}`)}})};export{k as LayoutPlugin};
